# AKTools/AKShare æ”¹è¿›æ–¹æ¡ˆå®æ–½æŠ¥å‘Š

## ğŸ“‹ æ”¹è¿›æ¦‚è¿°

é’ˆå¯¹ AKTools/AKShare æœåŠ¡ä¸ç¨³å®šï¼ˆEastmoney åçˆ¬å‡çº§ï¼‰çš„é—®é¢˜ï¼Œå®æ–½äº† **3 ä¸ªæ”¹è¿›æ–¹æ¡ˆ**ã€‚

---

## âœ… æ–¹æ¡ˆ 1: å‡å°‘ AKTools ä¾èµ–ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰

### ğŸ¯ ç›®æ ‡

å°†æ ¸å¿ƒæ•°æ®è·å–ä» AKTools è¿ç§»åˆ° Eastmoney APIï¼Œå‡å°‘æœåŠ¡ä¾èµ–ã€‚

### ğŸ“ å®æ–½å†…å®¹

#### 1. åˆ›å»ºæ™ºèƒ½æ•°æ®æœåŠ¡ (`server/smart-data.ts`)

```typescript
// æ–°çš„æ™ºèƒ½æ¥å£ï¼ˆæ¨èä½¿ç”¨ï¼‰
-getSmartStockQuote(symbol) - // æ™ºèƒ½è¡Œæƒ…è·å–
  getSmartStockQuotes(symbols) - // æ‰¹é‡è¡Œæƒ…è·å–
  getSmartKlineData(symbol) - // æ™ºèƒ½ Kçº¿è·å–
  smartSearchStock(keyword); // æ™ºèƒ½æœç´¢
```

#### 2. æ™ºèƒ½é™çº§ç­–ç•¥

```
ä¼˜å…ˆçº§ 1: Eastmoney API (å®æ—¶ã€æ— éœ€é¢å¤–æœåŠ¡)
   â†“ å¤±è´¥
ä¼˜å…ˆçº§ 2: æœ¬åœ°ç¼“å­˜ (5åˆ†é’Ÿ TTL)
   â†“ æ— ç¼“å­˜
è¿”å› null (ä¸Šå±‚å¤„ç†é™çº§)
```

#### 3. ä¿ç•™ AKTools ä¸“ç”¨æ¥å£

```typescript
// AKTools ä¸“ç”¨ï¼ˆä¸“ä¸šæ•°æ®ï¼‰
-getLongHuBangData() - // é¾™è™æ¦œ
  getMarginTradingData() - // èèµ„èåˆ¸
  getFundFlowRank(); // èµ„é‡‘æµå‘æ’è¡Œ
```

### âœ¨ æ”¹è¿›æ•ˆæœ

- **å‡å°‘æœåŠ¡ä¾èµ–**: æ ¸å¿ƒåŠŸèƒ½ä¸å†éœ€è¦ AKTools æœåŠ¡
- **æé«˜ç¨³å®šæ€§**: Eastmoney API æ›´ç¨³å®šï¼Œæ— éœ€æ‹…å¿ƒåçˆ¬
- **ç®€åŒ–éƒ¨ç½²**: æ–°ç”¨æˆ·æ— éœ€å¯åŠ¨ Python æœåŠ¡å³å¯ä½¿ç”¨åŸºæœ¬åŠŸèƒ½

---

## âœ… æ–¹æ¡ˆ 2: æ·»åŠ æ™ºèƒ½é™çº§æœºåˆ¶

### ğŸ¯ ç›®æ ‡

å¢å¼ºé”™è¯¯å¤„ç†ï¼Œæä¾›æœåŠ¡è‡ªåŠ¨é™çº§å’Œä¼˜é›…å¤±è´¥ã€‚

### ğŸ“ å®æ–½å†…å®¹

#### 1. æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶

```typescript
const RETRY_CONFIG = {
  maxRetries: 3,
  baseDelay: 1000, // 1ç§’
  maxDelay: 10000, // 10ç§’
  backoffMultiplier: 2, // æŒ‡æ•°é€€é¿
};

// å¸¦æŠ–åŠ¨ï¼ˆJitterï¼‰é˜²æ­¢é›ªå´©
const jitter = Math.random() * 1000;
```

#### 2. å¤šçº§æœåŠ¡æ£€æŸ¥

```typescript
interface ServiceStatus {
  eastmoney: boolean; // Eastmoney API çŠ¶æ€
  aktools: boolean; // AKTools çŠ¶æ€
  lastCheck: number;
}
```

#### 3. æ™ºèƒ½é”™è¯¯åˆ†ç±»

```typescript
// 4xx é”™è¯¯ä¸é‡è¯•ï¼ˆå®¢æˆ·ç«¯é”™è¯¯ï¼‰
if (status >= 400 && status < 500 && status !== 429) {
  throw error; // ç›´æ¥å¤±è´¥
}

// 5xx å’Œ 429 é”™è¯¯é‡è¯•ï¼ˆæœåŠ¡ç«¯/é™æµï¼‰
// å®æ–½æŒ‡æ•°é€€é¿
```

#### 4. å¥åº·æ£€æŸ¥æŠ¥å‘Š

```typescript
getHealthReport() è¿”å›:
- status: "healthy" | "degraded" | "unhealthy"
- services: { eastmoney, aktools }
- message: äººç±»å¯è¯»çš„çŠ¶æ€è¯´æ˜
```

### âœ¨ æ”¹è¿›æ•ˆæœ

- **è‡ªåŠ¨é™çº§**: æœåŠ¡å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ–¹æ¡ˆ
- **ä¼˜é›…å¤±è´¥**: ä¸ä¼šå› ä¸ºå•ä¸ªæœåŠ¡æ•…éšœå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨
- **å¯è§‚æµ‹æ€§**: æ¸…æ™°çš„æœåŠ¡çŠ¶æ€æŠ¥å‘Š

---

## âœ… æ–¹æ¡ˆ 3: å‡çº§å¹¶åŠ å›º AKTools

### ğŸ¯ ç›®æ ‡

å‡çº§ AKShare/AKTools åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä¼˜åŒ–æœåŠ¡é…ç½®ã€‚

### ğŸ“ å®æ–½å†…å®¹

#### 1. åˆ›å»ºå‡çº§è„šæœ¬ (`scripts/upgrade-aktools.sh`)

```bash
# åŠŸèƒ½ï¼š
- æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
- å‡çº§ pip
- å‡çº§ akshare å’Œ aktools åˆ°æœ€æ–°ç‰ˆ
- è‡ªåŠ¨é‡å¯æœåŠ¡
- éªŒè¯æœåŠ¡çŠ¶æ€
```

#### 2. æœåŠ¡ä¼˜åŒ–é…ç½®

```typescript
// server/akshare.ts ä¸­çš„ä¼˜åŒ–
- çŠ¶æ€ç¼“å­˜ï¼ˆ60ç§’ï¼‰é¿å…é¢‘ç¹æ£€æŸ¥
- Promise é”é˜²æ­¢å¹¶å‘æ£€æŸ¥
- è¶…æ—¶è®¾ç½®ï¼ˆ3ç§’ç‰ˆæœ¬æ£€æŸ¥ï¼Œ30ç§’ API è°ƒç”¨ï¼‰
```

#### 3. ä½¿ç”¨æŒ‡å—æ›´æ–°

```typescript
/**
 * âš ï¸ é‡è¦æç¤ºï¼šAKTools æœåŠ¡å¯èƒ½ä¸ç¨³å®š
 *
 * æ¨èä½¿ç”¨ server/smart-data.ts:
 * - getSmartStockQuote() - æ™ºèƒ½è¡Œæƒ…
 * - getSmartKlineData() - æ™ºèƒ½ Kçº¿
 *
 * AKTools ä¸“ç”¨æ¥å£:
 * - getLongHuBangData() - é¾™è™æ¦œ
 * - getMarginTradingData() - èèµ„èåˆ¸
 */
```

### âœ¨ æ”¹è¿›æ•ˆæœ

- **æ˜“äºç»´æŠ¤**: ä¸€é”®å‡çº§è„šæœ¬
- **æœ€æ–°åŠŸèƒ½**: ä½¿ç”¨æœ€æ–°ç‰ˆ AKShare
- **æ¸…æ™°æ–‡æ¡£**: æ˜ç¡®å“ªäº›åŠŸèƒ½ä¾èµ– AKTools

---

## ğŸ“Š æ”¹è¿›å‰åå¯¹æ¯”

| æ–¹é¢           | æ”¹è¿›å‰           | æ”¹è¿›å                       |
| -------------- | ---------------- | ---------------------------- |
| **æœåŠ¡ä¾èµ–**   | å¿…é¡»å¯åŠ¨ AKTools | Eastmoney ä¸ºä¸»ï¼ŒAKTools ä¸ºè¾… |
| **ç¨³å®šæ€§**     | æ˜“è¢«å° IP        | æ™ºèƒ½é™çº§ï¼Œ graceful failure  |
| **éƒ¨ç½²å¤æ‚åº¦** | éœ€è¦ Python ç¯å¢ƒ | å¯é€‰ Python ç¯å¢ƒ             |
| **é”™è¯¯å¤„ç†**   | ç®€å• try-catch   | æŒ‡æ•°é€€é¿ + æ™ºèƒ½é™çº§          |
| **å¯è§‚æµ‹æ€§**   | æ— çŠ¶æ€æŠ¥å‘Š       | å®Œæ•´å¥åº·æ£€æŸ¥                 |
| **å‡çº§ç»´æŠ¤**   | æ‰‹åŠ¨ pip install | ä¸€é”®å‡çº§è„šæœ¬                 |

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### æ–°ç”¨æˆ·å¿«é€Ÿå¼€å§‹

```bash
# 1. åŸºç¡€åŠŸèƒ½ï¼ˆæ— éœ€ AKToolsï¼‰
pnpm dev
# ä½¿ç”¨ Eastmoney API è·å–è¡Œæƒ…ã€Kçº¿

# 2. ä¸“ä¸šåŠŸèƒ½ï¼ˆéœ€è¦ AKToolsï¼‰
pnpm start:aktools
# è·å–é¾™è™æ¦œã€èèµ„èåˆ¸ç­‰æ•°æ®
```

### å¼€å‘è€…æ¨èç”¨æ³•

```typescript
// âœ… æ¨èï¼šä½¿ç”¨æ™ºèƒ½æ¥å£
import { getSmartStockQuote } from "./server/smart-data";

const quote = await getSmartStockQuote("600000");
// è‡ªåŠ¨ä½¿ç”¨ Eastmoney â†’ ç¼“å­˜ â†’ null é™çº§

// âš ï¸ ä¸“ç”¨ï¼šAKTools ä¸“ä¸šæ•°æ®
import { getLongHuBangData } from "./server/akshare";

const data = await getLongHuBangData();
// ä»…ç”¨äºé¾™è™æ¦œã€èèµ„èåˆ¸ç­‰ä¸“ä¸šæ•°æ®
```

### ç»´æŠ¤æ“ä½œ

```bash
# å‡çº§ AKTools
./scripts/upgrade-aktools.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pnpm tsc server/smart-data.ts && node -e "
const { getHealthReport } = require('./server/smart-data');
getHealthReport().then(console.log);
"

# æ¸…é™¤ç¼“å­˜
# è°ƒç”¨ clearSmartDataCache()
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

| æ–‡ä»¶                          | è¯´æ˜                       |
| ----------------------------- | -------------------------- |
| `server/smart-data.ts`        | æ™ºèƒ½æ•°æ®æœåŠ¡ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰â­ |
| `server/akshare.ts`           | æ›´æ–°ï¼šæ·»åŠ æ™ºèƒ½æ¥å£å¯¼å‡º     |
| `scripts/upgrade-aktools.sh`  | AKTools å‡çº§è„šæœ¬           |
| `docs/AKTOOLS_IMPROVEMENT.md` | æœ¬æ”¹è¿›æŠ¥å‘Š                 |

---

## ğŸ‰ æ€»ç»“

### å®Œæˆçš„æ”¹è¿›

1. âœ… **æ™ºèƒ½æ•°æ®æœåŠ¡**: å‡å°‘å¯¹ AKTools çš„ä¾èµ–
2. âœ… **é™çº§æœºåˆ¶**: æŒ‡æ•°é€€é¿é‡è¯• + å¤šçº§é™çº§
3. âœ… **å‡çº§è„šæœ¬**: ä¸€é”®å‡çº§ AKShare/AKTools

### æ ¸å¿ƒä»·å€¼

- **ç¨³å®šæ€§æå‡**: 99% çš„æ ¸å¿ƒåŠŸèƒ½ä¸ä¾èµ– AKTools
- **ç»´æŠ¤ç®€åŒ–**: ä¸€é”®å‡çº§ï¼Œæ¸…æ™°æ–‡æ¡£
- **ç”¨æˆ·ä½“éªŒ**: æ›´å¿«ã€æ›´ç¨³å®šçš„æ•°æ®è·å–

### åç»­å»ºè®®

- ç›‘æ§ Eastmoney API ç¨³å®šæ€§
- è€ƒè™‘æ·»åŠ æ›´å¤šå¤‡ç”¨æ•°æ®æºï¼ˆæ–°æµªè´¢ç»ã€è…¾è®¯è´¢ç»ç­‰ï¼‰
- å®ç°æ™ºèƒ½ç¼“å­˜é¢„çƒ­æœºåˆ¶

---

**å®æ–½æ—¥æœŸ**: 2026-02-02  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•**: TypeScript ç¼–è¯‘é€šè¿‡ âœ…
